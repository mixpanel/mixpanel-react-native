# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test_main_code:
    runs-on: macos-latest
    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install
      - run: npm test

  test_android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin" # See 'Supported distributions' for available options
          java-version: "17"
      - run: npm install
      - run: npm install -g react-native-cli
      - run: npm i react-native-gradle-plugin
      - name: Test Integration - Install dependencies
        working-directory: ./Samples/SimpleMixpanel
        run: yarn install
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Setup Android
        uses: reactivecircus/android-emulator-runner@v2.32.0
        with:
          api-level: 34
          target: google_apis
          profile: Nexus 5X
          arch: x86_64
          working-directory: ./Samples/SimpleMixpanel/android
          script: ./gradlew
      - name: Test Android
        uses: reactivecircus/android-emulator-runner@v2.32.0
        with:
          api-level: 34
          target: google_apis
          profile: Nexus 5X
          arch: x86_64
          working-directory: ./Samples/SimpleMixpanel
          script: react-native run-android

  test_ios:
    runs-on: macos-latest
    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install
      - run: npm install -g react-native-cli
      - name: Test Integration - Install dependencies
        working-directory: ./Samples/SimpleMixpanel
        run: npm install
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: List available simulators
        run: xcrun simctl list devices
      - name: Create and boot iOS Simulator
        run: |
          # Get the latest iOS runtime
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | tail -1 | awk '{print $NF}')
          echo "Using iOS Runtime: $RUNTIME"

          # Get available device types and use iPhone 14 or 15
          DEVICE_TYPE=$(xcrun simctl list devicetypes | grep -E "iPhone (14|15)" | grep -v "Pro\|Plus\|Max" | head -1 | sed 's/.*(\(.*\))/\1/')
          if [ -z "$DEVICE_TYPE" ]; then
            DEVICE_TYPE="iPhone-14"
          fi
          echo "Using Device Type: $DEVICE_TYPE"

          # Create simulator
          DEVICE_ID=$(xcrun simctl create "iPhone-CI" "$DEVICE_TYPE" "$RUNTIME")
          echo "Created simulator: $DEVICE_ID"

          # Boot simulator
          xcrun simctl boot "$DEVICE_ID"

          # Wait for simulator to boot
          xcrun simctl bootstatus "$DEVICE_ID" -b
      - name: Setup iOS
        working-directory: ./Samples/SimpleMixpanel/ios
        run: pod install --repo-update
      - name: Build iOS app
        working-directory: ./Samples/SimpleMixpanel/ios
        run: |
          xcodebuild -workspace SimpleMixpanel.xcworkspace \
            -scheme SimpleMixpanel \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build \
            -destination 'platform=iOS Simulator,name=iPhone-CI' \
            build
      - name: Test iOS app launch
        working-directory: ./Samples/SimpleMixpanel
        run: |
          # Install the app on simulator and launch it
          APP_PATH=$(find ios/build/Build/Products -name "*.app" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find built app"
            exit 1
          fi
          DEVICE_ID=$(xcrun simctl list devices | grep "iPhone-CI" | grep -oE '[A-F0-9-]{36}' | head -1)
          xcrun simctl install "$DEVICE_ID" "$APP_PATH"
          xcrun simctl launch "$DEVICE_ID" com.mixpanel.SimpleMixpanel
          # Give app time to launch and initialize
          sleep 10
          # Check if app is running
          xcrun simctl list | grep "iPhone-CI" | grep "Booted" || exit 1
